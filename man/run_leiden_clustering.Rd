% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/clustering.R
\name{run_leiden_clustering}
\alias{run_leiden_clustering}
\title{Leiden Clustering with Specified Resolution}
\usage{
run_leiden_clustering(
  umap_data,
  graph_path,
  gamma = 0.42,
  n_bootstrap = 100,
  subsample_prop = 0.8,
  stability_analysis = TRUE
)
}
\arguments{
\item{umap_data}{Either a file path (character string) to a CSV file containing
UMAP coordinates, or a data.frame with UMAP coordinates (typically from
\code{\link{run_umap_resolution_scan}}). If a data.frame is provided, it will
be saved to a temporary CSV file automatically.}

\item{graph_path}{Character string. File path to the saved UMAP graph (.pkl format)
created by \code{\link{run_umap_resolution_scan}}. This graph is used for
clustering to ensure consistency with the UMAP embedding.}

\item{gamma}{Numeric. Leiden resolution parameter controlling the granularity of
clustering. Lower values (e.g., 0.1-0.5) produce fewer, larger clusters; higher
values (e.g., 0.5-2.0) produce more, smaller clusters. Use the resolution scan
results to select an appropriate value. Default: 0.42.}

\item{n_bootstrap}{Integer. Number of bootstrap iterations for stability analysis.
Each iteration subsamples the data and re-clusters to assess consistency.
More iterations provide more reliable stability estimates but take longer.
Default: 100.}

\item{subsample_prop}{Numeric. Proportion of samples to include in each bootstrap
iteration (range: 0 to 1). For example, 0.8 means 80% of samples are randomly
selected for each iteration. Default: 0.8.}

\item{stability_analysis}{Logical. If TRUE, performs bootstrap stability analysis
to quantify how robust each cluster is to random subsampling. Results include
per-cluster stability scores. Default: TRUE.}
}
\value{
A list containing:
  \describe{
    \item{umap_df}{Data.frame with UMAP coordinates (UMAP1, UMAP2), condition
      labels (Class), and cluster assignments (Cluster) for each sample.}
    \item{stability}{Data.frame with bootstrap stability scores for each cluster
      (only included if stability_analysis=TRUE). Higher scores indicate more
      stable/robust clusters. Scores range from 0 to 1.}
  }
}
\description{
Performs community detection using the Leiden algorithm on a pre-computed UMAP
graph with a user-specified resolution parameter (gamma). This is the second
step in a two-stage clustering workflow, following \code{\link{run_umap_resolution_scan}}.
}
\details{
The Leiden algorithm is an improved version of the Louvain method for community
detection that guarantees well-connected communities. This function uses the
UMAP graph created by \code{\link{run_umap_resolution_scan}} and applies Leiden
clustering with the specified gamma value. Optionally performs bootstrap stability
analysis to assess cluster robustness.


This function calls a Python script that uses the leidenalg and igraph libraries.
The clustering is performed on the UMAP graph from the first step, ensuring that
the cluster structure is consistent with the UMAP visualization.

Bootstrap stability analysis works by repeatedly:
1. Randomly sampling a subset of the data (controlled by subsample_prop)
2. Running Leiden clustering on the subset
3. Measuring how consistently samples are assigned to the same clusters

Clusters with high stability scores are more reliable and likely represent
true biological or technical subpopulations.
}
\examples{
\dontrun{
# First, run UMAP and resolution scan
scan_results <- run_umap_resolution_scan(data = "features.csv")

# Examine resolution scan to choose gamma
plot_resolution_scan(scan_results$resolution_scan)

# Run Leiden clustering with chosen gamma
cluster_results <- run_leiden_clustering(
  umap_data = scan_results$umap_df,
  graph_path = scan_results$graph_path,
  gamma = 0.42,
  n_bootstrap = 100
)

# View cluster assignments
print(table(cluster_results$umap_df$Cluster))

# Plot UMAP colored by clusters
plot_umap(cluster_results$umap_df, color_by = "Cluster")

# Check cluster stability
plot_cluster_stability(cluster_results$stability)
}
}
\seealso{
\code{\link{run_umap_resolution_scan}} for the first step that creates
  the UMAP graph, \code{\link{plot_cluster_stability}} for visualizing stability
  results, \code{\link{plot_umap}} for visualizing cluster assignments
}
